<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - SmartBill+ Capital</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/css/dark-mode.css">
    <script src="/js/theme-and-notifications.js"></script>
    <style>
        body { font-family: 'Poppins', sans-serif; }
        .glass { background: rgba(255, 255, 255, 0.7); backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.2); }
        .hover-lift { transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
        .hover-lift:hover { transform: translateY(-4px); box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1); }
        .fade-in { animation: fadeIn 0.5s ease-in; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body class="bg-gradient-to-br from-slate-50 via-blue-50 to-indigo-50" onload="window.initTheme && window.initTheme()">
    <div class="flex h-screen">
        <!-- SIDEBAR -->
        <%- include('partials/sidebar', { currentPage: 'dashboard' }); %>

        <!-- Mobile overlay -->
        <div id="overlay" class="fixed inset-0 z-40 bg-black bg-opacity-50 lg:hidden hidden" onclick="toggleSidebar()"></div>

        <!-- Main content -->
        <div class="flex flex-1 flex-col lg:ml-64">
            <!-- HEADER -->
            <%- include('partials/header', { pageTitle: 'Dashboard' }); %>

            <!-- Page content -->
            <main class="flex-1 overflow-auto p-4 sm:p-6">
                <div class="fade-in">
                    <!-- Overview -->
                    <div class="mb-8">
                        <h2 class="text-3xl font-bold mb-2 dark:text-white" style="color: #111827 !important;">Overview</h2>
                        <p class="text-base text-gray-600 dark:text-gray-400 font-medium">Track your business performance</p>
                    </div>

                    <!-- Stats Cards -->
                    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
                        <!-- Bills Today -->
                        <div class="bg-gradient-to-br from-blue-500 to-blue-600 dark:from-blue-600 dark:to-blue-700 rounded-xl p-6 hover-lift shadow-lg text-white">
                            <div class="flex items-center justify-between mb-3">
                                <p class="text-sm font-medium opacity-90">Bills Today</p>
                                <svg class="w-8 h-8 opacity-80" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                                </svg>
                            </div>
                            <p id="stat-billsToday" class="text-4xl font-bold mb-2">0</p>
                            <p class="text-xs opacity-80">Daily transactions</p>
                        </div>

                        <!-- Total Sales -->
                        <div class="bg-gradient-to-br from-green-500 to-green-600 dark:from-green-600 dark:to-green-700 rounded-xl p-6 hover-lift shadow-lg text-white">
                            <div class="flex items-center justify-between mb-3">
                                <p class="text-sm font-medium opacity-90">Total Sales</p>
                                <svg class="w-8 h-8 opacity-80" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                                </svg>
                            </div>
                            <p id="stat-totalSales" class="text-4xl font-bold mb-2">₹0</p>
                            <p class="text-xs opacity-80">Revenue today</p>
                        </div>

                        <!-- Active Products -->
                        <div class="bg-gradient-to-br from-purple-500 to-purple-600 dark:from-purple-600 dark:to-purple-700 rounded-xl p-6 hover-lift shadow-lg text-white">
                            <div class="flex items-center justify-between mb-3">
                                <p class="text-sm font-medium opacity-90">Active Products</p>
                                <svg class="w-8 h-8 opacity-80" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4"/>
                                </svg>
                            </div>
                            <p id="stat-activeProducts" class="text-4xl font-bold mb-2">0</p>
                            <p class="text-xs opacity-80">In stock</p>
                        </div>

                        <!-- Profit Margin -->
                        <div class="bg-gradient-to-br from-orange-500 to-orange-600 dark:from-orange-600 dark:to-orange-700 rounded-xl p-6 hover-lift shadow-lg text-white">
                            <div class="flex items-center justify-between mb-3">
                                <p class="text-sm font-medium opacity-90">Profit Margin</p>
                                <svg class="w-8 h-8 opacity-80" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"/>
                                </svg>
                            </div>
                            <p id="stat-profitMargin" class="text-4xl font-bold mb-2">0%</p>
                            <p class="text-xs opacity-80">Monthly average</p>
                        </div>
                    </div>

                    <!-- Latest Bills Section -->
                    <div class="mt-8">
                        <h3 class="text-2xl font-bold mb-4 dark:text-white" style="color: #111827 !important;">Latest Bills</h3>
                        <div class="rounded-xl overflow-hidden shadow-lg border border-gray-200 dark:border-slate-600 bg-white dark:bg-slate-800">
                            <div class="overflow-x-auto">
                                <table class="w-full">
                                    <thead class="bg-gray-100 dark:bg-slate-700 border-b border-gray-200 dark:border-slate-600">
                                        <tr>
                                            <th class="px-6 py-3 text-left text-sm font-semibold" style="color: #111827 !important; background: inherit;"><span class="dark:text-white">Bill No.</span></th>
                                            <th class="px-6 py-3 text-left text-sm font-semibold" style="color: #111827 !important; background: inherit;"><span class="dark:text-white">Date</span></th>
                                            <th class="px-6 py-3 text-left text-sm font-semibold" style="color: #111827 !important; background: inherit;"><span class="dark:text-white">Amount</span></th>
                                            <th class="px-6 py-3 text-left text-sm font-semibold" style="color: #111827 !important; background: inherit;"><span class="dark:text-white">Status</span></th>
                                        </tr>
                                    </thead>
                                    <tbody id="bills-table-body" class="divide-y divide-gray-200 dark:divide-slate-600">
                                        <tr class="text-gray-500 dark:text-gray-400">
                                            <td colspan="4" class="px-6 py-8 text-center">Loading bills...</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
            </main>
        </div>
    </div>

    <script>
        const API_BASE = window.location.hostname === 'localhost' 
            ? 'http://localhost:5000/api' 
            : 'https://capital-yk88.onrender.com';

        async function loadDashboardData() {
            try {
                // Fetch bills
                const billsRes = await fetch(`${API_BASE}/bills/all`);
                const billsData = await billsRes.json();
                const bills = billsData.data || [];

                // Today's bills
                const today = new Date().toDateString();
                const todayBills = bills.filter(b => new Date(b.createdAt).toDateString() === today);
                
                document.getElementById('stat-billsToday').textContent = todayBills.length;

                const totalSales = todayBills.reduce((sum, b) => sum + (b.totalAmount || 0), 0);
                document.getElementById('stat-totalSales').textContent = '₹' + totalSales.toLocaleString('en-IN');

                // Fetch products
                const productsRes = await fetch(`${API_BASE}/products/all`);
                const productsData = await productsRes.json();
                const products = productsData.data || [];
                const activeProducts = products.filter(p => p.stock && p.stock > 0).length;
                document.getElementById('stat-activeProducts').textContent = activeProducts;

                // Profit margin
                const totalProfit = bills.reduce((sum, b) => {
                    const subtotal = b.subtotal || 0;
                    const profit = (b.totalAmount || 0) - subtotal;
                    return sum + profit;
                }, 0);
                const totalAmount = bills.reduce((sum, b) => sum + (b.totalAmount || 0), 0);
                const profitMargin = totalAmount > 0 ? ((totalProfit / totalAmount) * 100).toFixed(1) : 0;
                document.getElementById('stat-profitMargin').textContent = profitMargin + '%';

                // Load latest 5 bills
                const latestBills = bills.slice(-5).reverse();
                loadLatestBills(latestBills);
            } catch (error) {
                console.error('Error loading dashboard:', error);
            }
        }

        function loadLatestBills(bills) {
            const tbody = document.getElementById('bills-table-body');
            if (bills.length === 0) {
                tbody.innerHTML = '<tr class="text-gray-500 dark:text-gray-400"><td colspan="4" class="px-6 py-8 text-center">No bills yet</td></tr>';
                return;
            }

            tbody.innerHTML = bills.map((bill, idx) => {
                const date = new Date(bill.createdAt).toLocaleDateString('en-IN');
                const amount = (bill.totalAmount || 0).toLocaleString('en-IN');
                return `
                    <tr class="hover:bg-blue-50 dark:hover:bg-slate-700/50 transition-colors ${idx % 2 === 0 ? 'bg-white dark:bg-slate-800' : 'bg-gray-50 dark:bg-slate-800/50'}">
                        <td class="px-6 py-4 text-sm font-semibold text-gray-900 dark:text-white">${bill.billNumber || `#${bill._id?.slice(-6)}`}</td>
                        <td class="px-6 py-4 text-sm text-gray-600 dark:text-gray-400">${date}</td>
                        <td class="px-6 py-4 text-sm font-semibold text-green-600 dark:text-green-400">₹${amount}</td>
                        <td class="px-6 py-4 text-sm">
                            <span class="px-3 py-1 rounded-full text-xs font-semibold ${bill.isActive ? 'bg-green-100 dark:bg-green-900 text-green-800 dark:text-green-200' : 'bg-red-100 dark:bg-red-900 text-red-800 dark:text-red-200'}">
                                ${bill.isActive ? 'Active' : 'Inactive'}
                            </span>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('overlay');
            sidebar.classList.toggle('-translate-x-full');
            overlay.classList.toggle('hidden');
        }

        // Load on page ready
        window.addEventListener('load', () => {
            if (window.initTheme) window.initTheme();
            loadDashboardData();
        });

        // Auto-refresh every 30 seconds
        setInterval(loadDashboardData, 30000);
    </script>
</body>
</html>
