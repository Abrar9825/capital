<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reports - SmartBill+ Capital</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap"
        rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="/css/dark-mode.css">
    <script src="/js/theme-and-notifications.js"></script>
    <style>
        body {
            font-family: 'Poppins', sans-serif;
        }

        .glass {
            background: rgba(255, 255, 255, 0.7);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .hover-lift {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .hover-lift:hover {
            transform: translateY(-4px);
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
        }

        .fade-in {
            animation: fadeIn 0.5s ease-in;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .pulse-glow {
            animation: pulse-glow 2s infinite;
        }

        @keyframes pulse-glow {

            0%,
            100% {
                box-shadow: 0 0 5px rgba(102, 126, 234, 0.5);
            }

            50% {
                box-shadow: 0 0 20px rgba(102, 126, 234, 0.8), 0 0 30px rgba(102, 126, 234, 0.6);
            }
        }

        .nav-active {
            background: linear-gradient(to right, #2563eb, #4f46e5);
            color: white;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
        }

        .tab-active {
            background: linear-gradient(to right, #2563eb, #4f46e5);
            color: white;
        }

        /* Dark Mode */
        body.dark-mode {
            background: linear-gradient(to bottom right, #0f172a, #1e293b, #334155);
        }

        body.dark-mode .glass {
            background: rgba(30, 41, 59, 0.7);
            border-color: rgba(71, 85, 105, 0.3);
        }

        body.dark-mode .text-gray-900 {
            color: #f1f5f9 !important;
        }

        body.dark-mode .text-gray-800 {
            color: #e2e8f0 !important;
        }

        body.dark-mode .text-gray-700 {
            color: #cbd5e1 !important;
        }

        body.dark-mode .text-gray-600 {
            color: #cbd5e1 !important;
        }

        body.dark-mode .text-gray-500 {
            color: #94a3b8 !important;
        }

        body.dark-mode .bg-white {
            background-color: #1e293b !important;
        }

        body.dark-mode .border-gray-200 {
            border-color: #334155 !important;
        }

        body.dark-mode .border-gray-300 {
            border-color: #475569 !important;
        }

        body.dark-mode .hover\:bg-white\/50:hover {
            background-color: rgba(51, 65, 85, 0.5) !important;
        }

        body.dark-mode input,
        body.dark-mode select,
        body.dark-mode textarea {
            background-color: #1e293b !important;
            color: #e2e8f0 !important;
            border-color: #475569 !important;
        }

        body.dark-mode svg {
            color: #f1f5f9 !important;
            stroke: #f1f5f9 !important;
        }
    </style>
</head>

<body class="bg-gradient-to-br from-slate-50 via-blue-50 to-indigo-50">
    <div class="flex h-screen">
        <%- include('partials/sidebar', { currentPage: 'reports' }); %>

        <!-- Mobile sidebar overlay -->
        <div id="overlay" class="fixed inset-0 z-40 bg-black bg-opacity-50 lg:hidden hidden" onclick="toggleSidebar()">
        </div>

        <!-- Main content area -->
        <div class="flex flex-1 flex-col lg:ml-64">
            <%- include('partials/header', { pageTitle: 'Reports & Analytics' }); %>

            <!-- Page content -->
            <main class="flex-1 overflow-auto p-4 sm:p-6">
                <div class="fade-in">
                    <!-- Date Filter -->
                    <div class="glass rounded-lg p-3 mb-4">
                        <div class="flex flex-col sm:flex-row gap-2 items-start sm:items-center">
                            <div class="flex items-center space-x-2">
                                <svg class="h-4 w-4 text-gray-600" fill="none" stroke="currentColor"
                                    viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
                                </svg>
                                <span class="text-xs font-medium text-gray-700">Filter:</span>
                            </div>
                            <div class="flex gap-2 flex-wrap">
                                <button onclick="setDateFilter('today')"
                                    class="filter-btn px-3 py-1.5 rounded-lg border border-gray-300 hover:bg-white/50 transition text-xs font-medium text-gray-700">Today</button>
                                <button onclick="setDateFilter('week')"
                                    class="filter-btn px-3 py-1.5 rounded-lg border border-gray-300 hover:bg-white/50 transition text-xs font-medium text-gray-700">Week</button>
                                <button onclick="setDateFilter('month')"
                                    class="filter-btn px-3 py-1.5 rounded-lg border border-gray-300 hover:bg-white/50 transition text-xs font-medium bg-white text-gray-900">Month</button>
                                <button onclick="setDateFilter('year')"
                                    class="filter-btn px-3 py-1.5 rounded-lg border border-gray-300 hover:bg-white/50 transition text-xs font-medium text-gray-700">Year</button>
                            </div>
                        </div>
                    </div>

                    <!-- Tabs -->
                    <div class="glass rounded-lg p-1.5 mb-4 grid grid-cols-3 sm:flex sm:flex-wrap gap-1.5">
                        <button onclick="switchTab('sales')" id="tab-sales"
                            class="tab-active px-3 sm:px-4 py-2 rounded-lg font-medium transition text-xs sm:text-sm">Sales</button>
                        <button onclick="switchTab('profit')" id="tab-profit"
                            class="text-gray-700 hover:bg-white/50 px-3 sm:px-4 py-2 rounded-lg font-medium transition text-xs sm:text-sm">Profit</button>
                        <button onclick="switchTab('products')" id="tab-products"
                            class="text-gray-700 hover:bg-white/50 px-3 sm:px-4 py-2 rounded-lg font-medium transition text-xs sm:text-sm">Products</button>
                    </div>

                    <!-- Sales Report Tab -->
                    <div id="content-sales" class="tab-content">
                        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4 sm:gap-6 mb-6">
                            <div class="glass hover-lift rounded-xl p-4 sm:p-6 overflow-hidden">
                                <div class="flex flex-col">
                                    <p class="text-xs sm:text-sm font-medium text-gray-600 truncate">Total Sales</p>
                                    <p id="stat-totalSales"
                                        class="text-xl sm:text-2xl lg:text-3xl font-bold text-gray-900 mt-2 truncate">₹0
                                    </p>
                                    <p id="stat-salesChange" class="text-xs sm:text-sm text-green-600 mt-1">—</p>
                                </div>
                                <div
                                    class="p-2 sm:p-3 rounded-xl bg-gradient-to-r from-blue-500 to-blue-600 w-fit mt-2">
                                    <svg class="h-6 sm:h-8 w-6 sm:w-8 text-white" fill="none" stroke="currentColor"
                                        viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                            d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                                    </svg>
                                </div>
                            </div>
                            <div class="glass hover-lift rounded-xl p-4 sm:p-6 overflow-hidden">
                                <div class="flex flex-col">
                                    <p class="text-xs sm:text-sm font-medium text-gray-600 truncate">Total Bills</p>
                                    <p id="stat-totalBills"
                                        class="text-xl sm:text-2xl lg:text-3xl font-bold text-gray-900 mt-2 truncate">0
                                    </p>
                                    <p id="stat-billsChange" class="text-xs sm:text-sm text-green-600 mt-1">—</p>
                                </div>
                                <div
                                    class="p-2 sm:p-3 rounded-xl bg-gradient-to-r from-green-500 to-green-600 w-fit mt-2">
                                    <svg class="h-6 sm:h-8 w-6 sm:w-8 text-white" fill="none" stroke="currentColor"
                                        viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                            d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                                    </svg>
                                </div>
                            </div>
                            <div class="glass hover-lift rounded-xl p-4 sm:p-6 overflow-hidden">
                                <div class="flex flex-col">
                                    <p class="text-xs sm:text-sm font-medium text-gray-600 truncate">Avg Bill Value</p>
                                    <p id="stat-avgBillValue"
                                        class="text-xl sm:text-2xl lg:text-3xl font-bold text-gray-900 mt-2 truncate">₹0
                                    </p>
                                    <p id="stat-avgChange" class="text-xs sm:text-sm text-green-600 mt-1">—</p>
                                </div>
                                <div
                                    class="p-2 sm:p-3 rounded-xl bg-gradient-to-r from-purple-500 to-purple-600 w-fit mt-2">
                                    <svg class="h-6 sm:h-8 w-6 sm:w-8 text-white" fill="none" stroke="currentColor"
                                        viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                            d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6" />
                                    </svg>
                                </div>
                            </div>
                        </div>
                        <div class="glass rounded-lg sm:rounded-xl p-3 sm:p-4 lg:p-6 overflow-hidden w-full mb-6">
                            <div class="flex flex-col sm:flex-row sm:items-center gap-3 mb-4">
                                <h3 class="text-sm sm:text-base lg:text-lg font-bold text-gray-900">Recent Bills</h3>
                                <input type="text" id="billSearch" placeholder="Search bill number or customer..." 
                                    class="flex-1 px-3 py-2 border border-gray-300 rounded-lg text-xs sm:text-sm focus:outline-none focus:border-blue-500 bg-white"
                                    onkeyup="searchBills()">
                            </div>
                            <div id="recentBills" class="space-y-2 sm:space-y-3 max-h-96 overflow-y-auto">
                                <div class="text-center text-gray-500 py-4 text-xs sm:text-sm">Loading recent bills...</div>
                            </div>
                        </div>
                    </div>

                    <!-- Profit Analysis Tab -->
                    <div id="content-profit" class="tab-content hidden">
                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 sm:gap-6 mb-6">
                            <div class="glass hover-lift rounded-xl p-4 sm:p-6">
                                <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4 mb-4">
                                    <div>
                                        <p class="text-xs sm:text-sm font-medium text-gray-600">Total Tax Collected</p>
                                        <p id="stat-totalTax" class="text-2xl sm:text-3xl font-bold text-gray-900 mt-2">
                                            ₹0</p>
                                        <p class="text-xs sm:text-sm text-gray-500 mt-1">From selected period</p>
                                    </div>
                                    <div
                                        class="p-2 sm:p-3 rounded-xl bg-gradient-to-r from-green-500 to-emerald-600 w-fit">
                                        <svg class="h-6 sm:h-8 w-6 sm:w-8 text-white" fill="none" stroke="currentColor"
                                            viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                                d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                                        </svg>
                                    </div>
                                </div>
                            </div>
                            <div class="glass hover-lift rounded-xl p-4 sm:p-6">
                                <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4 mb-4">
                                    <div>
                                        <p class="text-xs sm:text-sm font-medium text-gray-600">Total Quantity Sold</p>
                                        <p id="stat-totalQuantity"
                                            class="text-2xl sm:text-3xl font-bold text-gray-900 mt-2">0</p>
                                        <p class="text-xs sm:text-sm text-gray-500 mt-1">Units sold</p>
                                    </div>
                                    <div
                                        class="p-2 sm:p-3 rounded-xl bg-gradient-to-r from-orange-500 to-orange-600 w-fit">
                                        <svg class="h-6 sm:h-8 w-6 sm:w-8 text-white" fill="none" stroke="currentColor"
                                            viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                                d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-2.293 2.293c-.63.63-.184 1.707.707 1.707H17m0 0a2 2 0 100 4 2 2 0 000-4zm-8 2a2 2 0 11-4 0 2 2 0 014 0z" />
                                        </svg>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="glass rounded-xl p-4 sm:p-6 overflow-hidden">
                            <h3 class="text-base sm:text-lg font-bold text-gray-900 mb-4">Payment Method Breakdown</h3>
                            <div style="height: 250px; min-height: 250px;">
                                <canvas id="paymentChart"></canvas>
                            </div>
                        </div>
                    </div>

                    <!-- Top Products Tab -->
                    <div id="content-products" class="tab-content hidden">
                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-4 sm:gap-6">
                            <div class="glass rounded-xl p-4 sm:p-6">
                                <h3 class="text-base sm:text-lg font-bold text-gray-900 mb-4">Top Selling Products</h3>
                                <div id="topProducts" class="space-y-2 sm:space-y-4">
                                    <div class="text-center text-gray-500 py-4">Loading products...</div>
                                </div>
                            </div>
                            <div class="glass rounded-xl p-4 sm:p-6 overflow-hidden">
                                <h3 class="text-base sm:text-lg font-bold text-gray-900 mb-4">Sales by Category</h3>
                                <div style="height: 250px; min-height: 250px;">
                                    <canvas id="categoryChart"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <script>
        let allBills = [];
        let currentDateFilter = 'month';
        let chartsInitialized = false;

        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('overlay');
            sidebar.classList.toggle('-translate-x-full');
            overlay.classList.toggle('hidden');
        }

        function switchTab(tabName) {
            // Hide all tab contents
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.add('hidden');
            });

            // Remove active class from all tabs
            document.querySelectorAll('[id^="tab-"]').forEach(tab => {
                tab.classList.remove('tab-active');
                tab.classList.add('text-gray-700', 'hover:bg-white/50');
            });

            // Show selected tab content
            document.getElementById('content-' + tabName).classList.remove('hidden');

            // Add active class to selected tab
            const selectedTab = document.getElementById('tab-' + tabName);
            selectedTab.classList.add('tab-active');
            selectedTab.classList.remove('text-gray-700', 'hover:bg-white/50');

            // Initialize charts when switching to tabs
            if (tabName === 'sales' && chartsInitialized) {
                updateCharts();
            } else if (tabName === 'profit' && chartsInitialized) {
                updatePaymentChart();
            } else if (tabName === 'products' && chartsInitialized) {
                updateCategoryChart();
            }
        }

        function setDateFilter(filter) {
            currentDateFilter = filter;
            // Update button styling
            const filterButtons = document.querySelectorAll('.filter-btn');
            filterButtons.forEach(btn => {
                btn.classList.remove('bg-white', 'text-gray-900');
                btn.classList.add('border-gray-300', 'text-gray-700');
            });
            event.target.classList.add('bg-white', 'text-gray-900');
            event.target.classList.remove('border-gray-300', 'text-gray-700');

            // Reload data and update all charts
            loadMetrics();
        }

        function exportReport() {
            alert('Exporting report to PDF...');
        }

        function handleLogout() {
            if (confirm('Are you sure you want to logout?')) {
                localStorage.removeItem('isLoggedIn');
                localStorage.removeItem('userEmail');
                localStorage.removeItem('userName');
                window.location.href = '/login';
            }
        }

        // Format currency
        function formatCurrency(value) {
            if (!value || value < 0) value = 0;
            const num = parseFloat(value);
            if (isNaN(num)) return '₹0';
            return new Intl.NumberFormat('en-IN', {
                style: 'currency',
                currency: 'INR',
                minimumFractionDigits: 0,
                maximumFractionDigits: 0
            }).format(num);
        }

        // Get date range based on filter
        function getDateRange(filter) {
            const end = new Date();
            const start = new Date();

            switch (filter) {
                case 'today':
                    start.setHours(0, 0, 0, 0);
                    break;
                case 'week':
                    start.setDate(end.getDate() - 7);
                    break;
                case 'month':
                    start.setMonth(end.getMonth() - 1);
                    break;
                case 'year':
                    start.setFullYear(end.getFullYear() - 1);
                    break;
            }
            return { start, end };
        }

        // Load metrics from API
        async function loadMetrics() {
            try {
                const response = await fetch('/api/bills/all');
                const data = await response.json();

                if (data.success && data.data) {
                    allBills = data.data;

                    // Calculate metrics from bills
                    const { start, end } = getDateRange(currentDateFilter);
                    const filteredBills = allBills.filter(bill => {
                        const billDate = new Date(bill.createdAt);
                        return billDate >= start && billDate <= end;
                    });

                    const metrics = {
                        totalBills: filteredBills.length,
                        totalRevenue: 0,
                        totalTax: 0,
                        averageBillValue: 0,
                        totalQuantitySold: 0,
                        topSellingProducts: [],
                        paymentBreakdown: {}
                    };

                    filteredBills.forEach(bill => {
                        const billAmount = bill.totalAmount || (bill.subtotal - (bill.discountAmount || 0) + (bill.taxAmount || 0)) || 0;
                        metrics.totalRevenue += billAmount;
                        metrics.totalTax += bill.taxAmount || 0;

                        if (bill.items) {
                            bill.items.forEach(item => {
                                metrics.totalQuantitySold += item.quantity || 0;
                            });
                        }

                        const method = bill.paymentMethod || 'cash';
                        if (!metrics.paymentBreakdown[method]) {
                            metrics.paymentBreakdown[method] = 0;
                        }
                        metrics.paymentBreakdown[method] += billAmount;
                    });

                    metrics.averageBillValue = filteredBills.length > 0 ? metrics.totalRevenue / filteredBills.length : 0;

                    // Calculate top products
                    const productMap = {};
                    filteredBills.forEach(bill => {
                        if (bill.items) {
                            bill.items.forEach(item => {
                                const productId = item._id || item.productId;
                                if (productId) {
                                    if (!productMap[productId]) {
                                        productMap[productId] = {
                                            quantity: 0,
                                            name: item.productName || 'Unknown Product'
                                        };
                                    }
                                    productMap[productId].quantity += item.quantity || 0;
                                }
                            });
                        }
                    });

                    metrics.topSellingProducts = Object.entries(productMap)
                        .map(([_id, data]) => ({
                            _id,
                            quantity: data.quantity,
                            name: data.name
                        }))
                        .sort((a, b) => b.quantity - a.quantity)
                        .slice(0, 10);

                    // Update stats
                    document.getElementById('stat-totalSales').textContent = formatCurrency(metrics.totalRevenue);
                    document.getElementById('stat-totalBills').textContent = metrics.totalBills;
                    document.getElementById('stat-avgBillValue').textContent = formatCurrency(metrics.averageBillValue);
                    document.getElementById('stat-totalTax').textContent = formatCurrency(metrics.totalTax);
                    document.getElementById('stat-totalQuantity').textContent = metrics.totalQuantitySold || 0;

                    // Store for chart updates
                    window.currentMetrics = metrics;

                    // Update charts if initialized
                    if (chartsInitialized) {
                        updateCharts();
                        updatePaymentChart();
                        updateCategoryChart();
                        renderTopProducts();
                        renderRecentBills();
                    }
                } else {
                    console.error('Error: No data returned from bills API');
                }
            } catch (error) {
                console.error('Error loading metrics:', error);
                document.getElementById('stat-totalSales').textContent = '₹0';
                document.getElementById('stat-totalBills').textContent = '0';
            }
        }

        // Load all bills for calculations
        async function initializeData() {
            try {
                await loadMetrics();
            } catch (error) {
                console.error('Error initializing data:', error);
            }
        }

        // Update sales trend chart (removed - using search instead)
        function updateCharts() {
            // Chart removed - replaced with search functionality
        }

        // Update payment method chart
        function updatePaymentChart() {
            if (!window.currentMetrics) return;

            const metrics = window.currentMetrics;
            const paymentMethods = Object.keys(metrics.paymentBreakdown || {});
            const paymentAmounts = Object.values(metrics.paymentBreakdown || {});

            const ctx = document.getElementById('paymentChart');
            if (ctx && ctx.chart) {
                ctx.chart.destroy();
            }

            new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: paymentMethods.length > 0 ? paymentMethods : ['No Data'],
                    datasets: [{
                        data: paymentAmounts.length > 0 ? paymentAmounts : [1],
                        backgroundColor: [
                            'rgba(59, 130, 246, 0.8)',
                            'rgba(34, 197, 94, 0.8)',
                            'rgba(168, 85, 247, 0.8)',
                            'rgba(249, 115, 22, 0.8)',
                            'rgba(239, 68, 68, 0.8)'
                        ],
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { position: 'bottom' } }
                }
            });
            ctx.chart = document.getElementById('paymentChart').chart;
        }

        // Update category chart
        function updateCategoryChart() {
            if (!window.currentMetrics) return;

            const metrics = window.currentMetrics;
            const topProducts = metrics.topSellingProducts || [];

            const productNames = topProducts.slice(0, 5).map((p, i) => `Product ${i + 1}`);
            const productQuantities = topProducts.slice(0, 5).map(p => p.quantity || 0);

            const ctx = document.getElementById('categoryChart');
            if (ctx && ctx.chart) {
                ctx.chart.destroy();
            }

            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: productNames.length > 0 ? productNames : ['No Data'],
                    datasets: [{
                        label: 'Quantity Sold',
                        data: productQuantities.length > 0 ? productQuantities : [0],
                        backgroundColor: 'rgba(59, 130, 246, 0.8)',
                        borderRadius: 6
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: true, position: 'top' } },
                    scales: {
                        y: { beginAtZero: true, grid: { color: 'rgba(0, 0, 0, 0.05)' } },
                        x: { grid: { display: false } }
                    }
                }
            });
            ctx.chart = document.getElementById('categoryChart').chart;
        }

        // Render top products
        function renderTopProducts() {
            if (!window.currentMetrics) return;

            const metrics = window.currentMetrics;
            const topProducts = metrics.topSellingProducts || [];
            const container = document.getElementById('topProducts');

            if (topProducts.length === 0) {
                container.innerHTML = '<div class="text-center text-gray-500 py-4">No products sold</div>';
                return;
            }

            const colors = ['from-yellow-400 to-yellow-500', 'from-gray-400 to-gray-500', 'from-orange-400 to-orange-500', 'from-blue-400 to-blue-500', 'from-purple-400 to-purple-500'];

            container.innerHTML = topProducts.slice(0, 5).map((product, index) => `
                <div class="flex items-center justify-between p-2 sm:p-3 bg-white/50 rounded-lg gap-2">
                    <div class="flex items-center space-x-2 sm:space-x-3 min-w-0">
                        <div class="h-8 sm:h-10 w-8 sm:w-10 rounded-lg bg-gradient-to-r ${colors[index]} flex items-center justify-center text-white font-bold text-xs sm:text-base flex-shrink-0">${index + 1}</div>
                        <div class="min-w-0">
                            <p class="text-xs sm:text-sm font-semibold text-gray-900 truncate">${product.name || 'Unknown Product'}</p>
                            <p class="text-xs text-gray-600">${product.quantity} units</p>
                        </div>
                    </div>
                    <span class="text-xs sm:text-lg font-bold text-gray-900 flex-shrink-0">${product.quantity}</span>
                </div>
            `).join('');
        }

        // Render recent bills
        function renderRecentBills() {
            const container = document.getElementById('recentBills');
            const recentBills = allBills.slice(0, 10) || [];

            if (recentBills.length === 0) {
                container.innerHTML = '<div class="text-center text-gray-500 py-4 text-xs sm:text-sm">No bills found</div>';
                return;
            }

            container.innerHTML = recentBills.map(bill => {
                const billDate = new Date(bill.createdAt).toLocaleDateString('en-IN');
                const billAmount = bill.totalAmount || (bill.subtotal - (bill.discountAmount || 0) + (bill.taxAmount || 0)) || 0;
                const statusColor = bill.paymentStatus === 'completed' ? 'bg-green-50' : 'bg-yellow-50';
                const statusText = bill.paymentStatus === 'completed' ? '✓ Done' : 'Pending';
                const statusColor2 = bill.paymentStatus === 'completed' ? 'text-green-700' : 'text-yellow-700';
                
                return `
                    <div class="flex items-center justify-between p-2 sm:p-3 ${statusColor} rounded-lg gap-2 hover:shadow-md hover:bg-opacity-70 transition cursor-pointer" onclick="window.open('/billPreview?billNumber=${bill.billNumber}', '_blank')">
                        <div class="min-w-0">
                            <p class="text-xs sm:text-sm font-semibold text-gray-900">${bill.billNumber || 'N/A'}</p>
                            <p class="text-xs text-gray-600">${bill.customerName || 'Customer'}</p>
                            <p class="text-xs text-gray-500">${billDate}</p>
                        </div>
                        <div class="text-right flex-shrink-0">
                            <p class="text-xs sm:text-sm font-bold text-gray-900">₹${Math.round(billAmount)}</p>
                            <p class="text-xs ${statusColor2} font-semibold">${statusText}</p>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Initialize on page load
        window.onload = function () {
            if (localStorage.getItem('isLoggedIn') !== 'true') {
                window.location.href = '/login';
            }

            // Load saved theme
            const savedTheme = localStorage.getItem('theme');
            if (savedTheme === 'dark') {
                document.body.classList.add('dark-mode');
            }

            // Load data
            initializeData();

            // Initialize charts after short delay
            setTimeout(() => {
                chartsInitialized = true;
                updateCharts();
                updatePaymentChart();
                updateCategoryChart();
                renderTopProducts();
                renderRecentBills();
            }, 1500);
        };
    </script>
</body>

</html>