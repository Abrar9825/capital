<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Capital Bill - Preview</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;900&display=swap" rel="stylesheet">
    
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }
        .paper {
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
        }
        
        @page {
            margin: 0;
            padding: 0;
            size: auto;
        }

        @media print {
            * {
                margin: 0;
                padding: 0;
                box-sizing: border-box;
                -webkit-print-color-adjust: exact !important;
                print-color-adjust: exact !important;
                color-adjust: exact !important;
            }

            html, body {
                width: 100%;
                height: 100%;
                margin: 0 !important;
                padding: 0 !important;
                background-color: white;
                font-size: 12pt;
            }

            /* Hide browser header/footer (URL, page numbers, etc) */
            @page {
                margin: 0;
                padding: 0;
            }

            /* Hide all non-bill content */
            .fixed, script, .no-print, button, [onclick], header, footer, nav {
                display: none !important;
                visibility: hidden !important;
                height: 0 !important;
                width: 0 !important;
                position: absolute !important;
            }

            .paper {
                box-shadow: none !important;
                width: 100%;
                max-width: 100%;
                margin: 0;
                padding: 20px;
                page-break-after: always;
                background-color: #fcfcfc !important;
                position: static !important;
            }

            .paper:last-child {
                page-break-after: avoid;
            }

            table {
                width: 100%;
                border-collapse: collapse;
            }

            tr, td, th {
                page-break-inside: avoid;
            }

            div, span, p, li, h1, h2, h3, h4, h5, h6 {
                -webkit-print-color-adjust: exact !important;
                print-color-adjust: exact !important;
            }
        }
    </style>
</head>
<body class="flex justify-center items-start min-h-screen p-2 sm:p-4">

    <!-- Action Buttons -->
    <div class="fixed top-4 right-4 z-50 flex gap-2 no-print">
        <button onclick="printAllBills()" class="bg-blue-600 hover:bg-blue-700 text-white px-3 sm:px-4 py-2 rounded-lg text-xs sm:text-sm font-medium shadow-lg transition">
            üñ®Ô∏è Print
        </button>
        <button onclick="shareBillOnWhatsApp()" class="bg-green-600 hover:bg-green-700 text-white px-3 sm:px-4 py-2 rounded-lg text-xs sm:text-sm font-medium shadow-lg transition">
            üí¨ Share
        </button>
        <button onclick="completeBill()" class="bg-gray-600 hover:bg-gray-700 text-white px-3 sm:px-4 py-2 rounded-lg text-xs sm:text-sm font-medium shadow-lg transition">
            ‚úì Done
        </button>
    </div>

    <!-- Bills Container -->
    <div id="bills-container" class="space-y-4 p-4 sm:p-6 w-full max-w-5xl"></div>

    <script>
        function getUrlParam(param) {
            const urlParams = new URLSearchParams(window.location.search);
            const value = urlParams.get(param);
            try {
                return value ? JSON.parse(decodeURIComponent(value)) : null;
            } catch (e) {
                return decodeURIComponent(value || '');
            }
        }

        function generateBillHTML(billNumber, billIndex, totalBills, items, subtotal, discount, tax, total, gstRate, gstNumber) {
            const emptyRows = Math.max(0, 15 - (items.length % 15));
            
            return `
                <div class="paper bg-white w-full max-w-[800px] mx-auto relative flex flex-col min-h-[1000px]">
                    <!-- Header -->
                    <div class="bg-[#231f20] text-white p-4">
                        <div class="flex justify-between items-start mb-2">
                            <div></div>
                            <div class="text-right">
                                <div class="flex items-center gap-2 text-sm">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z" />
                                    </svg>
                                    <span class="font-semibold">Hamza : 9978078241</span>
                                </div>
                                <div class="text-xs mt-1">@CAPITALAHIS</div>
                            </div>
                        </div>

                        <div class="text-center mt-2">
                            <h1 class="text-6xl font-black tracking-widest">CAPITAL</h1>
                            <p class="text-sm font-semibold mt-0.5">(DHALGARWADWALA)</p>
                            <p class="text-xs font-light">Exclusive Ready to Wear Available in XL to 8XL SIZES</p>
                        </div>

                        <div class="mt-2 pt-2 border-t border-gray-500 text-center text-xs font-light">
                            S/101, Above Huseni Bakery, Opp. Nayara Petrol Pump, Juhapura, Ahmedabad.
                        </div>
                    </div>

                    <!-- Date & Bill Info -->
                    <div class="px-4 py-2 flex justify-between items-center border-b border-black">
                        <span class="text-xs text-gray-600">Bill ${billIndex}/${totalBills}</span>
                        <div class="flex items-center gap-2">
                            <span class="text-red-700 font-bold text-sm">Date :</span>
                            <div class="border-b-2 border-black px-2 min-w-[120px] text-center">
                                <span class="font-bold text-sm">${new Date().toLocaleDateString('en-IN')}</span>
                            </div>
                        </div>
                    </div>

                    <!-- Table with exactly 15 rows -->
                    <div class="px-4">
                        <table class="w-full border-collapse text-sm mt-2">
                            <thead>
                                <tr class="bg-[#231f20] text-white text-xs font-bold border border-black">
                                    <th class="py-2 px-2 text-left w-[50%] border-r border-black">Particulars</th>
                                    <th class="py-2 px-1 text-center w-[15%] border-r border-black">Qty.</th>
                                    <th class="py-2 px-1 text-center w-[18%] border-r border-black">Rate</th>
                                    <th class="py-2 px-1 text-center w-[17%]">Amount</th>
                                </tr>
                            </thead>
                            <tbody class="text-black text-xs">
                                ${items.map(item => `
                                    <tr class="border border-black h-7">
                                        <td class="px-2 align-middle border-r border-black truncate">${item.name || item.productName}</td>
                                        <td class="px-1 text-center align-middle border-r border-black">${item.quantity}</td>
                                        <td class="px-1 text-center align-middle border-r border-black">‚Çπ${(item.price || 0).toFixed(2)}</td>
                                        <td class="px-1 text-center align-middle">‚Çπ${(item.quantity * (item.price || 0)).toFixed(2)}</td>
                                    </tr>
                                `).join('')}
                                ${Array(15 - items.length).fill(0).map(() => `
                                    <tr class="border border-black h-7">
                                        <td class="px-2 border-r border-black"></td>
                                        <td class="border-r border-black"></td>
                                        <td class="border-r border-black"></td>
                                        <td></td>
                                    </tr>
                                `).join('')}
                                <tr class="border border-black h-6">
                                    <td class="px-2 py-1 align-middle border-r border-black font-bold text-xs" rowspan="4">GSTIN : <br><span class="font-normal text-[0.65rem]">${gstNumber}</span></td>
                                    <td colspan="2" class="px-2 text-right align-middle border-r border-black font-semibold">Subtotal :</td>
                                    <td class="px-1 text-center align-middle font-semibold">‚Çπ${subtotal.toFixed(2)}</td>
                                </tr>
                                ${discount > 0 ? `
                                <tr class="border border-black h-6">
                                    <td colspan="2" class="px-2 text-right align-middle border-r border-black font-semibold text-green-600">Discount :</td>
                                    <td class="px-1 text-center align-middle text-green-600 font-semibold">- ‚Çπ${discount.toFixed(2)}</td>
                                </tr>
                                ` : `
                                <tr class="border border-black h-6">
                                    <td colspan="2" class="px-2 text-right align-middle border-r border-black"></td>
                                    <td class="px-1 text-center align-middle"></td>
                                </tr>
                                `}
                                ${tax > 0 ? `
                                <tr class="border border-black h-6">
                                    <td colspan="2" class="px-2 text-right align-middle border-r border-black font-semibold">GST (${gstRate}%) :</td>
                                    <td class="px-1 text-center align-middle font-semibold">‚Çπ${tax.toFixed(2)}</td>
                                </tr>
                                ` : `
                                <tr class="border border-black h-6">
                                    <td colspan="2" class="px-2 text-right align-middle border-r border-black"></td>
                                    <td class="px-1 text-center align-middle"></td>
                                </tr>
                                `}
                                <tr class="border border-black h-6 bg-gray-50">
                                    <td colspan="2" class="px-2 text-right align-middle border-r border-black font-bold text-red-600">Total</td>
                                    <td class="px-1 text-center align-middle font-bold text-red-600">‚Çπ${total.toFixed(2)}</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>

                    <!-- Footer -->
                    <div class="px-4 py-2 border-t border-black">
                        <div class="flex justify-between items-end text-xs mb-2">
                            <ul class="list-disc pl-4 text-red-600 space-y-0.5">
                                <li class="text-black">Once the goods is sold it wont be relumed.</li>
                                <li>You can change within 4 days from the bill date.</li>
                                <li><span class="text-red-600">No Discount</span> <span class="text-black">‚Ä¢</span> <span class="text-red-600">No Return</span></li>
                                <li class="text-black">Friday 12.30 to 1.45 Closed</li>
                            </ul>
                            <div class="text-right">
                                <p class="text-xs font-semibold mb-1">From,</p>
                                <p class="text-2xl font-black tracking-widest">CAPITAL</p>
                            </div>
                        </div>
                    </div>

                    <!-- Footer Bar -->
                    <div class="flex h-5 w-full">
                        <div class="bg-[#231f20] w-[75%]"></div>
                        <div class="bg-[#c52b2b] w-[25%]"></div>
                    </div>
                </div>
            `;
        }

        function initializeBills() {
            const billNumbers = getUrlParam('billNumbers') || [getUrlParam('billNumber')];
            const subtotal = parseFloat(getUrlParam('subtotal')) || 0;
            const discount = parseFloat(getUrlParam('discount')) || 0;
            const tax = parseFloat(getUrlParam('tax')) || 0;
            const total = parseFloat(getUrlParam('total')) || 0;
            const gstRate = parseFloat(getUrlParam('gstRate')) || 18;
            const gstNumber = getUrlParam('gstNumber') || '--';
            const allItems = getUrlParam('items') || [];

            const ITEMS_PER_BILL = 15;
            const container = document.getElementById('bills-container');

            if (!billNumbers || billNumbers.length === 0) {
                container.innerHTML = '<div class="text-center text-red-600 py-10">‚ö†Ô∏è No bills to display</div>';
                return;
            }

            // If this is a single bill from reports/history page, fetch it from API
            if (billNumbers.length === 1 && allItems.length === 0) {
                const billNumber = billNumbers[0];
                fetchAndRenderBill(billNumber);
                return;
            }

            // Otherwise, use the multi-bill preview logic (from billing page)
            renderMultiBills(billNumbers, subtotal, discount, tax, total, gstRate, gstNumber, allItems, ITEMS_PER_BILL, container);
        }

        function fetchAndRenderBill(billNumber) {
            const container = document.getElementById('bills-container');
            container.innerHTML = '<div class="text-center text-gray-500 py-10">Loading bill...</div>';

            fetch(`/api/bills/number/${billNumber}`)
                .then(res => res.json())
                .then(data => {
                    if (!data.success || !data.data) {
                        container.innerHTML = '<div class="text-center text-red-600 py-10">‚ùå Bill not found</div>';
                        return;
                    }

                    const bill = data.data;
                    
                    // Check for related bills (multi-bill scenario)
                    // Bills from same order have same customerPhone and createdAt within same second
                    const createdAtTime = new Date(bill.createdAt).getTime();
                    const timeWindow = 5000; // 5 second window to group multi-bills
                    
                    fetch(`/api/bills/all`)
                        .then(res => res.json())
                        .then(allBillsData => {
                            if (allBillsData.success && allBillsData.data) {
                                const relatedBills = allBillsData.data.filter(b => {
                                    const billTime = new Date(b.createdAt).getTime();
                                    return b.customerPhone === bill.customerPhone && 
                                           Math.abs(billTime - createdAtTime) < timeWindow &&
                                           b.isActive === true;
                                }).sort((a, b) => a.createdAt - b.createdAt);

                                if (relatedBills.length > 0) {
                                    renderRelatedBills(relatedBills);
                                } else {
                                    renderSingleBill(bill);
                                }
                            } else {
                                renderSingleBill(bill);
                            }
                        })
                        .catch(error => {
                            console.error('Error fetching related bills:', error);
                            renderSingleBill(bill);
                        });
                })
                .catch(error => {
                    console.error('Error fetching bill:', error);
                    container.innerHTML = '<div class="text-center text-red-600 py-10">‚ùå Error loading bill</div>';
                });
        }

        function renderSingleBill(bill) {
            const container = document.getElementById('bills-container');
            const billItems = (bill.items || []).map(item => ({
                productName: item.productName || 'Product',
                quantity: item.quantity || 1,
                price: item.finalPrice || 0
            }));

            const html = generateBillHTML(
                bill.billNumber,
                1,
                1,
                billItems,
                bill.subtotal || 0,
                bill.discountAmount || 0,
                bill.taxAmount || 0,
                bill.totalAmount || 0,
                bill.gstRate || 18,
                bill.gstNumber || '--'
            );
            container.innerHTML = html;
        }

        function renderRelatedBills(bills) {
            const container = document.getElementById('bills-container');
            let html = '';
            
            bills.forEach((bill, index) => {
                const billItems = (bill.items || []).map(item => ({
                    productName: item.productName || 'Product',
                    quantity: item.quantity || 1,
                    price: item.finalPrice || 0
                }));

                html += generateBillHTML(
                    bill.billNumber,
                    index + 1,
                    bills.length,
                    billItems,
                    bill.subtotal || 0,
                    bill.discountAmount || 0,
                    bill.taxAmount || 0,
                    bill.totalAmount || 0,
                    bill.gstRate || 18,
                    bill.gstNumber || '--'
                );
            });
            
            container.innerHTML = html;
        }

        function renderMultiBills(billNumbers, subtotal, discount, tax, total, gstRate, gstNumber, allItems, ITEMS_PER_BILL, container) {
            console.log('Bill Numbers:', billNumbers);
            console.log('All Items:', allItems);
            console.log('Total Items:', allItems.length);

            if (!billNumbers || billNumbers.length === 0) {
                container.innerHTML = '<div class="text-center text-red-600 py-10">‚ö†Ô∏è No bills to display</div>';
                return;
            }

            billNumbers.forEach((billNumber, index) => {
                const startIdx = index * ITEMS_PER_BILL;
                const endIdx = Math.min(startIdx + ITEMS_PER_BILL, allItems.length);
                const billItems = allItems.slice(startIdx, endIdx);

                // Proportional calculation
                const billItemsSubtotal = billItems.reduce((sum, item) => sum + (item.quantity * item.price), 0);
                const totalItemsSubtotal = allItems.reduce((sum, item) => sum + (item.quantity * item.price), 0);
                
                const billDiscount = totalItemsSubtotal > 0 ? (billItemsSubtotal / totalItemsSubtotal) * discount : 0;
                const billTax = ((billItemsSubtotal - billDiscount) * gstRate) / 100;
                const billTotal = billItemsSubtotal - billDiscount + billTax;

                console.log(`Bill ${index + 1}: ${billItems.length} items, Subtotal: ${billItemsSubtotal}`);

                const html = generateBillHTML(billNumber, index + 1, billNumbers.length, billItems, billItemsSubtotal, billDiscount, billTax, billTotal, gstRate, gstNumber);
                container.innerHTML += html;
            });
        }

        function printAllBills() {
            window.print();
        }

        async function shareBillOnWhatsApp() {
            try {
                const btn = event.target;
                btn.disabled = true;
                btn.innerHTML = '‚è≥ Generating PDF...';

                const billNumbers = getUrlParam('billNumbers') || [getUrlParam('billNumber')];
                const customerPhone = getUrlParam('customerPhone') || '';
                const total = getUrlParam('total') || '0';
                
                if (!billNumbers || billNumbers.length === 0) {
                    alert('No bill to share');
                    btn.disabled = false;
                    btn.innerHTML = 'üí¨ Share';
                    return;
                }

                const firstBillNumber = Array.isArray(billNumbers) ? billNumbers[0] : billNumbers;
                
                // Generate PDF and upload to GitHub
                const pdfUrl = await generateAndUploadPDF(firstBillNumber, btn);
                
                if (pdfUrl) {
                    btn.innerHTML = '‚è≥ Opening WhatsApp...';
                    
                    // Create WhatsApp message
                    let phoneNumber = customerPhone.replace(/\D/g, '');
                    if (phoneNumber.length === 10) {
                        phoneNumber = '91' + phoneNumber;
                    }
                    
                    const message = `Hi! Your Bill #${firstBillNumber} is ready.\nAmount: ‚Çπ${total}\nView PDF: ${pdfUrl}`;
                    const whatsappUrl = `https://wa.me/${phoneNumber}?text=${encodeURIComponent(message)}`;
                    
                    setTimeout(() => {
                        window.open(whatsappUrl, '_blank');
                        btn.disabled = false;
                        btn.innerHTML = 'üí¨ Share';
                    }, 1000);
                } else {
                    alert('Failed to generate or upload PDF');
                    btn.disabled = false;
                    btn.innerHTML = 'üí¨ Share';
                }
            } catch (error) {
                console.error('Error sharing bill:', error);
                alert('Error: ' + error.message);
                event.target.disabled = false;
                event.target.innerHTML = 'üí¨ Share';
            }
        }

        async function generateAndUploadPDF(billNumber, btn) {
            return new Promise((resolve) => {
                // Check if html2pdf is already loaded
                if (window.html2pdf) {
                    processPDFGeneration();
                    return;
                }
                
                // Load html2pdf library
                const script = document.createElement('script');
                script.src = 'https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js';
                
                script.onload = function() {
                    processPDFGeneration();
                };
                
                script.onerror = function() {
                    console.error('Failed to load PDF library');
                    alert('Failed to load PDF library');
                    resolve(null);
                };
                
                document.head.appendChild(script);

                async function processPDFGeneration() {
                    try {
                        const billElement = document.querySelector('.paper');
                        if (!billElement) {
                            console.error('Bill element not found');
                            alert('Bill not found');
                            resolve(null);
                            return;
                        }

                        const opt = {
                            margin: 5,
                            filename: `Bill-${billNumber}.pdf`,
                            image: { type: 'jpeg', quality: 0.85 },
                            html2canvas: { 
                                scale: 1.5,
                                useCORS: true,
                                allowTaint: true
                            },
                            jsPDF: { 
                                orientation: 'portrait', 
                                unit: 'mm', 
                                format: 'a4',
                                compress: true
                            }
                        };

                        if (btn) btn.innerHTML = '‚è≥ Creating PDF...';

                        // Generate PDF as blob
                        const pdfBlob = await html2pdf()
                            .set(opt)
                            .from(billElement)
                            .outputPdf('blob');
                        
                        console.log('PDF Blob Size:', (pdfBlob.size / 1024).toFixed(2), 'KB');

                        if (btn) btn.innerHTML = '‚è≥ Converting to base64...';

                        // Convert to base64
                        const reader = new FileReader();
                        reader.onload = async function() {
                            const base64Content = reader.result.split(',')[1];
                            
                            if (btn) btn.innerHTML = '‚è≥ Uploading to GitHub...';
                            
                            // Upload to GitHub
                            const githubUrl = await uploadToGitHub(billNumber, base64Content);
                            resolve(githubUrl);
                        };
                        reader.onerror = function() {
                            console.error('FileReader error');
                            alert('Error reading PDF');
                            resolve(null);
                        };
                        reader.readAsDataURL(pdfBlob);
                    } catch (error) {
                        console.error('PDF generation error:', error);
                        alert('PDF generation failed: ' + error.message);
                        resolve(null);
                    }
                }
            });
        }

        async function uploadToGitHub(billNumber, base64Content) {
            try {
                console.log('üì§ Uploading PDF to GitHub:', billNumber);
                console.log('Base64 size:', (base64Content.length / 1024).toFixed(2), 'KB');
                
                const response = await fetch('/api/bills/store-github-pdf', {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        billNumber: billNumber,
                        pdfContent: base64Content
                    })
                });

                console.log('Upload response status:', response.status);

                if (!response.ok) {
                    const error = await response.json();
                    console.error('Upload failed:', error);
                    alert('Upload failed: ' + error.message);
                    return null;
                }

                const data = await response.json();
                console.log('Upload result:', data);

                if (data.success && data.pdfUrl) {
                    console.log('‚úÖ PDF URL:', data.pdfUrl);
                    return data.pdfUrl;
                }
                
                console.error('No PDF URL returned');
                alert('No PDF URL returned from server');
                return null;
            } catch (error) {
                console.error('GitHub upload error:', error);
                alert('Upload error: ' + error.message);
                return null;
            }
        }

        function completeBill() {
            if (confirm('Done? Go back to billing?')) {
                window.location.href = '/billing';
            }
        }

        // Initialize when page loads
        window.addEventListener('DOMContentLoaded', initializeBills);
    </script>
</body>
</html>
